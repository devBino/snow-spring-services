name: CI dos Projetos Spring Boot SnowManLabs

on:
    push:
        branches: [develop, release/1.2.0]

env:
  JWT_SECRET: ${{ secrets.JWT_SECRET }}

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
          
            - name: Baixando Codigos Fontes
              uses: actions/checkout@v3

            - name: Setup JDK 17
              uses: actions/setup-java@v3
              with:
                distribution: 'temurin'
                java-version: '17'
                cache: maven

            - name: Build do MS Api Livros
              working-directory: ./api-livros
              run: mvn package -DskipTests

            - name: Build do MS Servico Email
              working-directory: ./servico-email
              run: mvn package -Pdevelopment

            - name: Build do MS Objetos Seguranca
              working-directory: ./objetos-seguranca
              run: mvn package -Pdevelopment

            - name: Configurando Docker Compose
              working-directory: ./
              run: docker-compose -f ./docker-compose.yml up -d
      
            - name: Aguardando o serviços subirem
              run: |
                RETRIES=5
                until curl -s http://localhost:8091/actuator/health | grep -q 'UP'; do
                  echo "Aguardando o MS Api Livros subir..."
                  sleep 15
                  RETRIES=$((RETRIES-1))
                  if [ $RETRIES -le 0 ]; then
                    echo "O MS Api Livros não subiu a tempo."
                    exit 1
                  fi
                done
      
            - name: Testes de Integração do MS Api Livros
              working-directory: ./api-livros
              run: mvn test -Pdevelopment
      
            - name: Derrubando os Serviços
              working-directory: ./
              run: docker-compose -f ./docker-compose.yml down
